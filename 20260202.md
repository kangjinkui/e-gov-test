# 2026-02-02 작업 내역

## 개요
MyBatis 매퍼 빈 등록 실패 문제를 해결하고, DB 데이터 마이그레이션 및 REST API JSON 응답을 정상 동작시킴

## 해결한 문제들

### 1. MyBatis 매퍼 빈 등록 실패 (@EgovMapper 누락)

**문제:**
- eGovFrame의 `MapperConfigurer`가 매퍼 인터페이스를 Spring 빈으로 등록하지 못함
- `CustomUserDetailsService`에서 `@Resource(name = "authMapper")` 주입 시 빈을 찾을 수 없음
- 에러: `No bean named 'authMapper' available`

**원인:**
- eGovFrame의 `MapperConfigurer`는 `@EgovMapper` 어노테이션이 붙은 인터페이스만 스캔
- 기존 예제 `SampleMapper`에는 `@EgovMapper("sampleMapper")`가 있었으나
- lawmatcher 모듈의 매퍼 인터페이스 11개에는 모두 어노테이션이 없었음

**해결:**
모든 매퍼 인터페이스에 `@EgovMapper` 어노테이션 추가

```java
// 변경 전
public interface AuthMapper { ... }

// 변경 후
@EgovMapper("authMapper")
public interface AuthMapper { ... }
```

**수정된 파일 (11개):**

| 파일 | 빈 이름 |
|------|---------|
| auth/mapper/AuthMapper.java | `authMapper` |
| law/mapper/LawMapper.java | `lawMapper` |
| law/mapper/LawSnapshotMapper.java | `lawSnapshotMapper` |
| law/mapper/LawAmendmentMapper.java | `lawAmendmentMapper` |
| law/mapper/LawChangeMapper.java | `lawChangeMapper` |
| ordinance/mapper/OrdinanceMapper.java | `ordinanceMapper` |
| ordinance/mapper/OrdinanceArticleMapper.java | `ordinanceArticleMapper` |
| ordinance/mapper/OrdinanceLawMappingMapper.java | `ordinanceLawMappingMapper` |
| department/mapper/DepartmentMapper.java | `departmentMapper` |
| review/mapper/ReviewMapper.java | `reviewMapper` |
| dashboard/mapper/DashboardMapper.java | `dashboardMapper` |

---

### 2. MyBatis 매퍼 XML 중복 등록

**문제:**
- `SqlSessionFactoryBean` 초기화 시 `Result Maps collection already contains key` 에러
- 예: `lawAmendmentMap`이 두 번 등록됨

**원인:**
매퍼 XML이 두 곳에서 동시에 로드됨:
1. `sql-mapper-config.xml`의 `<mappers>` 섹션
2. `context-mapper.xml`의 `mapperLocations` 속성

**해결:**
`sql-mapper-config.xml`에서 `<mappers>` 섹션 제거 (typeAliases만 유지)

```xml
<!-- 변경 전 -->
<configuration>
    <typeAliases>...</typeAliases>
    <mappers>
        <mapper resource="egovframework/sqlmap/auth/Auth_SQL.xml"/>
        <!-- ... 10개 매퍼 -->
    </mappers>
</configuration>

<!-- 변경 후 -->
<configuration>
    <typeAliases>...</typeAliases>
</configuration>
```

**수정된 파일:**
- `resources/egovframework/sqlmap/lawmatcher/sql-mapper-config.xml`

---

### 3. Spring Security + MVC 컨텍스트 분리 문제

**문제:**
- `SecurityConfig`에서 `requestMatchers()` 호출 시 `HandlerMappingIntrospector` 빈을 찾을 수 없음
- 에러: `No bean named 'mvcHandlerMappingIntrospector'`

**원인:**
- `SecurityConfig`는 root ApplicationContext에서 로드됨
- MVC 관련 빈은 dispatcher-servlet ApplicationContext에서 로드됨
- `requestMatchers(String)`은 내부적으로 `MvcRequestMatcher`를 사용하려 하지만, root context에 MVC 빈이 없음

**해결:**
`AntPathRequestMatcher`를 명시적으로 사용

```java
// 변경 전
.requestMatchers("/api/admin/**").hasRole("ADMIN")
.requestMatchers("/api/**").authenticated()

// 변경 후
.requestMatchers(new AntPathRequestMatcher("/api/admin/**")).hasRole("ADMIN")
.requestMatchers(new AntPathRequestMatcher("/api/**")).authenticated()
```

**수정된 파일:**
- `auth/SecurityConfig.java`

---

### 4. example 모듈 빈 등록 누락

**문제:**
- `EgovSampleController`가 `sampleService` 빈을 찾지 못함
- 에러: `No bean named 'sampleService' available`

**원인:**
- `context-common.xml`에서 `egovframework.lawmatcher` 패키지만 component-scan
- `dispatcher-servlet.xml`에서 example 컨트롤러를 스캔하지만, service/mapper 빈이 없음

**해결:**

1. **component-scan 추가** (`context-common.xml`)
```xml
<context:component-scan base-package="egovframework.lawmatcher" />
<context:component-scan base-package="egovframework.example" />
```

2. **MapperConfigurer basePackage 확장** (`context-mapper.xml`)
```xml
<!-- 변경 전 -->
<property name="basePackage" value="egovframework.lawmatcher" />

<!-- 변경 후 -->
<property name="basePackage" value="egovframework" />
```

3. **example 매퍼 XML 로드 추가** (`context-mapper.xml`)
```xml
<value>classpath:/egovframework/sqlmap/example/mappers/*.xml</value>
```

4. **example typeAlias 추가** (`sql-mapper-config.xml`)
```xml
<typeAlias alias="searchVO" type="egovframework.example.sample.service.SampleDefaultVO"/>
<typeAlias alias="sampleVO" type="egovframework.example.sample.service.SampleVO"/>
```

**수정된 파일:**
- `resources/egovframework/spring/context-common.xml`
- `resources/egovframework/spring/context-mapper.xml`
- `resources/egovframework/sqlmap/lawmatcher/sql-mapper-config.xml`

---

### 5. DB 테이블 생성 및 데이터 마이그레이션

**문제:**
- lawmatcher 관련 테이블이 DB에 존재하지 않음
- `/api/laws` 호출 시 `relation "laws" does not exist` 에러

**해결:**
- `law-matcher/backup.sql`을 활용하여 egov-postgres에 테이블 생성 및 데이터 import
- owner를 `lawmatcher` → `egov_user`로 변환

```bash
# owner 변환 후 import
sed -e 's/OWNER TO lawmatcher/OWNER TO egov_user/g' backup.sql > backup_adapted.sql
docker cp backup_adapted.sql egov-postgres:/tmp/
docker exec egov-postgres psql -U egov_user -d egov_lawmatcher -f /tmp/backup_adapted.sql
```

**생성된 테이블 및 데이터:**

| 테이블 | 건수 | 설명 |
|--------|------|------|
| laws | 494 | 법령 기본정보 |
| law_changes | 1,754 | 법령 변경이력 |
| law_snapshots | 0 | 법령 스냅샷 |
| law_amendments | 0 | 법령 개정 |
| ordinances | 513 | 조례 |
| ordinance_articles | 0 | 조례 조항 |
| ordinance_law_mappings | 593 | 법령-조례 매핑 |
| departments | 0 | 부서 |
| amendment_reviews | 0 | 개정 검토 |
| alembic_version | 1 | 마이그레이션 버전 |

기존 테이블 (auth/sample): `users`, `roles`, `user_roles`, `sample`, `ids`

---

### 6. Jackson 라이브러리 누락 (JSON 응답 불가)

**문제:**
- REST API 호출 시 406 Not Acceptable 에러
- `@RestController`가 JSON 직렬화를 하려면 Jackson이 필요

**해결:**
`pom.xml`에 Jackson 의존성 추가

```xml
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>2.18.3</version>
</dependency>
```

**수정된 파일:**
- `pom.xml`

---

## 최종 동작 확인

### 앱 기동 로그
```
Root WebApplicationContext initialized in 4022 ms
Global AuthenticationManager configured with UserDetailsService bean with name customUserDetailsService
Completed initialization in 981 ms
Server startup in [17710] milliseconds
```

### API 테스트 결과
```bash
# 메인 페이지
curl http://localhost:8080/          # 200 OK

# 법률 목록 (494건 JSON 반환)
curl http://localhost:8080/api/laws  # 200 OK, JSON 배열

# 개별 법률 조회
curl http://localhost:8080/api/laws/1  # 200 OK, JSON 객체
```

---

## 수정된 파일 전체 목록

### 설정 파일 (5개)
1. `pom.xml` - jackson-databind 의존성 추가
2. `resources/egovframework/spring/context-common.xml` - example component-scan 추가
3. `resources/egovframework/spring/context-mapper.xml` - basePackage 확장, example 매퍼 추가
4. `resources/egovframework/sqlmap/lawmatcher/sql-mapper-config.xml` - mappers 제거, example alias 추가
5. `auth/SecurityConfig.java` - AntPathRequestMatcher 사용

### 매퍼 인터페이스 (11개)
모두 `@EgovMapper` 어노테이션 추가:
1. auth/mapper/AuthMapper.java
2. law/mapper/LawMapper.java
3. law/mapper/LawSnapshotMapper.java
4. law/mapper/LawAmendmentMapper.java
5. law/mapper/LawChangeMapper.java
6. ordinance/mapper/OrdinanceMapper.java
7. ordinance/mapper/OrdinanceArticleMapper.java
8. ordinance/mapper/OrdinanceLawMappingMapper.java
9. department/mapper/DepartmentMapper.java
10. review/mapper/ReviewMapper.java
11. dashboard/mapper/DashboardMapper.java

---

## 문제 해결 요약

| 문제 | 원인 | 해결책 |
|------|------|--------|
| 매퍼 빈 등록 실패 | `@EgovMapper` 어노테이션 누락 | 11개 매퍼에 어노테이션 추가 |
| ResultMap 중복 등록 | config + mapperLocations 이중 로드 | `<mappers>` 섹션 제거 |
| MVC introspector 없음 | root/servlet context 분리 | AntPathRequestMatcher 사용 |
| sampleService 빈 없음 | component-scan 범위 부족 | example 패키지 scan 추가 |
| laws 테이블 없음 | DDL 미실행 | backup.sql import |
| 406 Not Acceptable | Jackson 라이브러리 없음 | jackson-databind 추가 |

## 접속 정보

| 항목 | 값 |
|------|-----|
| 앱 URL | http://localhost:8080 |
| API 베이스 | http://localhost:8080/api |
| DB Host | localhost:5433 |
| DB Name | egov_lawmatcher |
| DB User | egov_user / egov_pass123 |
